# YaneuraOu定跡データ全量取り込み実装計画

## 概要
YaneuraOuの定跡データベース（user_book1.db、約500MB）を全量取り込み、Web将棋AIに統合する実装計画。

## ファイル情報
- ファイル名: `user_book1.db`
- サイズ: 約493MB
- フォーマット: YaneuraOu定跡形式
- ライセンス: MITライセンス

## YaneuraOu定跡フォーマット
```
#YANEURAOU-DB2016 1.00
sfen [局面SFEN] [手番] [持ち駒] [手数]
[指し手] [次の局面] [評価値] [深さ] [出現回数]
```

### フォーマット詳細
- `sfen`: 局面をSFEN形式で表現
- `手番`: b(先手) / w(後手)
- `持ち駒`: 持ち駒の表現（例: "2P" = 歩2枚）
- `手数`: 現在の手数
- `指し手`: 移動元と移動先（例: "7g7f"）
- `評価値`: その手の評価値（cp単位）
- `深さ`: 探索深さ
- `出現回数`: データベース内での出現回数

## 実装チェックリスト

### Phase 1: 基盤準備
- [ ] ライセンスファイルの作成
  - [ ] プロジェクトルートにLICENSEファイル作成
  - [ ] YaneuraOu定跡データのクレジット追加
  - [ ] README.mdへのクレジット情報追加

### Phase 2: パーサー実装
- [ ] `packages/core/src/ai/yaneuraouParser.ts`の作成
  - [ ] SFEN形式のパース処理
  - [ ] 指し手記法の変換（"7g7f" → Move型）
  - [ ] 持ち駒情報のパース
  - [ ] エラーハンドリング

### Phase 3: 変換スクリプト（全量版）
- [ ] `packages/core/scripts/convertOpeningBook.ts`の作成
  - [ ] ストリーミング処理の実装
  - [ ] バッチ処理（10万行ごと）
  - [ ] 進捗表示
  - [ ] 出力形式の決定（分割JSON or バイナリ）
  - [ ] 圧縮オプション

### Phase 4: 大容量ローダー
- [ ] `packages/core/src/ai/openingBookLoader.ts`の作成
  - [ ] 分割ファイルの読み込み
  - [ ] インデックス構築
  - [ ] WebWorkerでのバックグラウンド読み込み
  - [ ] メモリ効率の最適化

### Phase 5: AI統合
- [ ] `openingBookSearch.ts`の拡張
  - [ ] 大容量データ対応
  - [ ] キャッシュサイズの調整
- [ ] AIワーカーの更新
  - [ ] 段階的読み込みの実装
  - [ ] メモリ監視

### Phase 6: テストと最適化
- [ ] パフォーマンステスト
  - [ ] メモリ使用量測定
  - [ ] 検索速度ベンチマーク
  - [ ] 初回起動時間測定
- [ ] 最適化
  - [ ] 必要に応じてIndexedDB実装
  - [ ] 圧縮アルゴリズムの選定

## 技術的考慮事項

### メモリ管理
- 500MBのデータを効率的に扱うため、以下を考慮：
  - 遅延読み込み（Lazy Loading）
  - 分割ファイル化
  - LRUキャッシュの活用
  - 不要なデータの早期解放

### パフォーマンス
- 初回起動時の高速化
  - コア定跡のみ先行読み込み
  - バックグラウンドで全量読み込み
- 検索の高速化
  - ハッシュマップによるO(1)検索
  - 多層インデックス構造

### ブラウザ制限
- メモリ上限への配慮（通常2-4GB）
- WebWorkerでのメモリ分離
- 長時間処理での応答性確保

## 実装メモ
- 全量取り込みは技術的チャレンジだが、現代のブラウザなら実現可能
- 段階的な実装で、問題があれば早期に発見できる構成
- 将来的にはサーバーサイドでの定跡検索も検討可能

## 更新履歴
- 2025-01-03: 初版作成